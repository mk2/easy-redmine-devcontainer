name: DevContainer CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test-devcontainer:
    name: Test DevContainer Setup
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout DevContainer repository
        uses: actions/checkout@v4
        with:
          path: easy-redmine-devcontainer

      - name: Clone Redmine from official repository
        uses: actions/checkout@v4
        with:
          repository: redmine/redmine
          ref: master
          path: redmine

      - name: Setup DevContainer environment
        run: |
          cat > easy-redmine-devcontainer/.devcontainer/.env << 'EOF'
          CI=true
          REDMINE_PATH=../../redmine
          INSTALL_CLAUDE_CODE=false
          INSTALL_OPENAI_CODEX=false
          SELENIUM_IMAGE=selenium/standalone-chrome
          EOF

      - name: Configure Redmine database connection
        run: |
          cat > redmine/config/database.yml << 'EOF'
          development:
            adapter: postgresql
            database: redmine_development
            host: db
            username: postgres
            password: postgres
            encoding: unicode
          EOF

      - name: Build and start services
        working-directory: easy-redmine-devcontainer/.devcontainer
        run: |
          docker compose build
          docker compose up -d

          # Wait for services to be ready
          echo "Waiting for services to start..."
          sleep 10

          # Debug: show running containers and networks
          echo "=== Running containers ==="
          docker compose ps
          echo "=== Networks ==="
          docker network ls
          echo "=== App container network settings ==="
          docker compose exec -T app cat /etc/hosts || true
          docker compose exec -T app ping -c 2 db || true

      - name: Wait for database
        working-directory: easy-redmine-devcontainer/.devcontainer
        run: |
          echo "Waiting for PostgreSQL to be ready..."
          for i in $(seq 1 30); do
            if docker compose exec -T db pg_isready -U postgres; then
              echo "PostgreSQL is ready!"
              break
            fi
            echo "Attempt $i: PostgreSQL not ready yet..."
            sleep 2
          done

          # Verify app can reach db
          echo "=== Verifying app can reach db ==="
          docker compose exec -T app getent hosts db || echo "getent failed, trying nslookup..."
          docker compose exec -T app nslookup db || echo "nslookup also failed"

      - name: Setup Redmine
        working-directory: easy-redmine-devcontainer/.devcontainer
        run: |
          echo "=== Installing Ruby dependencies ==="
          docker compose exec -T app bash -c "cd /workspaces/redmine && bundle install --jobs 4"

          echo "=== Creating database ==="
          docker compose exec -T app bash -c "cd /workspaces/redmine && bundle exec rake db:create"

          echo "=== Running migrations ==="
          docker compose exec -T app bash -c "cd /workspaces/redmine && bundle exec rake db:migrate"

          echo "=== Loading default data ==="
          docker compose exec -T app bash -c "cd /workspaces/redmine && bundle exec rake redmine:load_default_data RAILS_ENV=development REDMINE_LANG=en"

      - name: Start Rails server and verify HTTP 200
        working-directory: easy-redmine-devcontainer/.devcontainer
        run: |
          echo "=== Starting Rails server ==="
          docker compose exec -T -d app bash -c "cd /workspaces/redmine && bundle exec rails server -b 0.0.0.0 -p 3000"

          echo "=== Waiting for Rails server ==="
          sleep 5

          echo "=== Verifying HTTP 200 ==="
          for i in $(seq 1 30); do
            if docker compose exec -T app curl -sSf http://localhost:3000/ > /dev/null 2>&1; then
              echo "SUCCESS: HTTP 200 OK"
              docker compose exec -T app curl -I http://localhost:3000/
              exit 0
            fi
            echo "Attempt $i: Server not ready yet..."
            sleep 2
          done

          echo "FAILURE: Server did not respond"
          docker compose logs app
          exit 1

      - name: Cleanup
        if: always()
        working-directory: easy-redmine-devcontainer/.devcontainer
        run: docker compose down -v
